<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Attendance - Scan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body class="bg-gray-50">
  <nav class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-indigo-600">QR Attendance</h1>
      <div class="flex gap-4 items-center">
        <a href="/dashboard" class="text-gray-700 hover:text-indigo-600 font-medium">Dashboard</a>
        <a href="/scan" class="text-gray-700 hover:text-indigo-600 font-medium">Scan</a>
        <a href="/attendance" class="text-gray-700 hover:text-indigo-600 font-medium">Attendance</a>
        <button id="logoutBtn" onclick="logout()" class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">Logout</button>
      </div>
    </div>
  </nav>

  <div class="max-w-2xl mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-md p-8">
      <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Attendance Check-in</h2>
      
      <!-- Camera Scanner -->
      <div id="cameraView" class="space-y-6">
        <div class="bg-gray-100 rounded-lg overflow-hidden">
          <video id="cameraStream" class="w-full aspect-video bg-black rounded-lg" playsinline></video>
          <canvas id="canvas" class="hidden"></canvas>
        </div>
        <div class="flex gap-3">
          <button id="startCameraBtn" onclick="startCamera()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg">Start Camera</button>
          <button id="stopCameraBtn" onclick="stopCamera()" class="hidden flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg">Stop Camera</button>
        </div>
        <div id="scanStatus" class="text-center text-gray-600 text-sm">Click "Start Camera" to begin scanning</div>
      </div>
      
      <!-- HR View -->
      <div id="hrView" class="hidden space-y-6">
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-gray-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">ID</p>
            <p id="memberId" class="text-xl font-semibold text-gray-800"></p>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">Patient Name</p>
            <p id="memberName" class="text-xl font-semibold text-gray-800"></p>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">Hospital Name</p>
            <p id="memberTeam" class="text-xl font-semibold text-gray-800"></p>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">Major</p>
            <p id="memberGovernorate" class="text-xl font-semibold text-gray-800"></p>
          </div>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <p class="text-sm text-gray-600">Status</p>
          <p id="memberStatus" class="text-2xl font-bold text-blue-600"></p>
          <p id="memberTime" class="text-sm text-gray-600 mt-2"></p>
        </div>

        <button id="markPresentBtn" onclick="markPresent()" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg text-lg">Mark Present</button>
      </div>

      <!-- User View (Ticket) -->
      <div id="userView" class="hidden space-y-6">
        <div class="bg-gradient-to-r from-indigo-600 to-blue-600 text-white p-6 rounded-lg">
          <h3 class="text-2xl font-bold mb-2" id="ticketName"></h3>
          <p class="text-sm opacity-90" id="ticketHospital"></p>
        </div>

        <div class="space-y-3 bg-gray-50 p-4 rounded-lg">
          <div class="flex justify-between">
            <span class="text-gray-600">ID:</span>
            <span class="font-semibold" id="ticketId"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Major:</span>
            <span class="font-semibold" id="ticketMajor"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Status:</span>
            <span class="font-semibold" id="ticketStatus"></span>
          </div>
        </div>

        <div class="border-t-2 border-dashed border-gray-300 my-4"></div>

        <div class="text-center">
          <p class="text-gray-600 text-sm mb-3 font-semibold">Your Ticket</p>
          <div class="flex justify-center">
            <img id="ticketQR" src="" alt="Ticket QR" class="w-40 h-40 border-2 border-gray-300 rounded-lg p-2 bg-white">
          </div>
        </div>
      </div>

      <div id="noMemberInfo" class="hidden text-center py-12">
        <p class="text-gray-600 text-lg">Scan a QR code to check in</p>
      </div>
    </div>
  </div>

  <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
      <h3 class="text-lg font-semibold text-green-600 mb-2">Success</h3>
      <p id="successMessage" class="text-gray-700 mb-4"></p>
      <button onclick="closeSuccessModal()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg">Close</button>
    </div>
  </div>

  <div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
      <h3 class="text-lg font-semibold text-red-600 mb-2">Error</h3>
      <p id="errorMessage" class="text-gray-700 mb-4"></p>
      <button onclick="closeErrorModal()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg">Close</button>
    </div>
  </div>

  <script>
    let currentMemberId = null;
    let isLoggedIn = false;
    let cameraActive = false;
    let videoStream = null;
    let animationId = null;

    async function startCamera() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false
        });
        
        const video = document.getElementById('cameraStream');
        video.srcObject = videoStream;
        video.play();
        
        cameraActive = true;
        document.getElementById('startCameraBtn').classList.add('hidden');
        document.getElementById('stopCameraBtn').classList.remove('hidden');
        document.getElementById('scanStatus').textContent = 'Scanning... Point camera at QR code';
        
        scanQRCode();
      } catch (err) {
        showErrorModal('Unable to access camera. Please check permissions.');
        console.error('Camera error:', err);
      }
    }

    function stopCamera() {
      cameraActive = false;
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
      }
      if (animationId) {
        cancelAnimationFrame(animationId);
      }
      document.getElementById('startCameraBtn').classList.remove('hidden');
      document.getElementById('stopCameraBtn').classList.add('hidden');
      document.getElementById('scanStatus').textContent = 'Camera stopped';
    }

    function scanQRCode() {
      const video = document.getElementById('cameraStream');
      const canvas = document.getElementById('canvas');
      const context = canvas.getContext('2d');

      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: 'dontInvert'
        });

        if (code) {
          const url = new URL(code.data, window.location.origin);
          const token = url.searchParams.get('token');
          
          if (token) {
            stopCamera();
            document.getElementById('scanStatus').textContent = 'QR code detected! Loading...';
            loadMemberInfo(token);
            return;
          }
        }
      }

      if (cameraActive) {
        animationId = requestAnimationFrame(scanQRCode);
      }
    }

    async function loadMemberInfo(scannedToken = null) {
      const params = new URLSearchParams(window.location.search);
      const urlToken = params.get('token');
      const token = scannedToken || urlToken;

      if (!token) {
        document.getElementById('hrView').classList.add('hidden');
        document.getElementById('userView').classList.add('hidden');
        document.getElementById('noMemberInfo').classList.remove('hidden');
        return;
      }

      currentMemberId = token;

      try {
        const response = await fetch(`/api/member/${token}`);
        const data = await response.json();

        if (data.success) {
          isLoggedIn = data.isLoggedIn;

          if (isLoggedIn) {
            // HR View
            document.getElementById('memberId').textContent = data.member.id;
            document.getElementById('memberName').textContent = data.member.patient_name;
            document.getElementById('memberTeam').textContent = data.member.hospital_name;
            document.getElementById('memberGovernorate').textContent = data.member.major;
            document.getElementById('memberStatus').textContent = data.status;
            document.getElementById('memberTime').textContent = data.time !== '-' ? `Time: ${data.time}` : '';

            if (data.status === 'Invited') {
              document.getElementById('markPresentBtn').classList.remove('hidden');
            } else {
              document.getElementById('markPresentBtn').classList.add('hidden');
            }

            document.getElementById('hrView').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
          } else {
            // User View (Ticket)
            document.getElementById('ticketId').textContent = data.member.id;
            document.getElementById('ticketName').textContent = data.member.patient_name;
            document.getElementById('ticketHospital').textContent = data.member.hospital_name;
            document.getElementById('ticketMajor').textContent = data.member.major;
            document.getElementById('ticketStatus').textContent = data.status;

            // Generate Ticket QR
            const qrResponse = await fetch(`/api/generate-ticket-qr/${token}`);
            const qrData = await qrResponse.json();
            
            if (qrData.success) {
              document.getElementById('ticketQR').src = qrData.qrImage;
            }

            document.getElementById('userView').classList.remove('hidden');
          }

          document.getElementById('cameraView').classList.add('hidden');
          document.getElementById('noMemberInfo').classList.add('hidden');
        } else {
          showErrorModal(data.message || 'Member not found');
          document.getElementById('cameraView').classList.remove('hidden');
          setTimeout(() => startCamera(), 2000);
        }
      } catch (err) {
        showErrorModal('Error loading member information');
        document.getElementById('cameraView').classList.remove('hidden');
        setTimeout(() => startCamera(), 2000);
      }
    }

    async function markPresent() {
      if (!currentMemberId) return;

      try {
        const response = await fetch(`/api/mark-present/${currentMemberId}`, {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          showSuccessModal('Marked present successfully!');
          setTimeout(() => {
            document.getElementById('hrView').classList.add('hidden');
            document.getElementById('userView').classList.add('hidden');
            document.getElementById('cameraView').classList.remove('hidden');
            document.getElementById('scanStatus').textContent = 'Click "Start Camera" to scan another QR code';
            startCamera();
          }, 2000);
        } else {
          showErrorModal(data.message || 'Error marking present');
        }
      } catch (err) {
        showErrorModal('Error marking present');
      }
    }

    async function logout() {
      try {
        await fetch('/api/logout', { method: 'POST' });
        window.location.href = '/login';
      } catch (err) {
        showErrorModal('Error logging out');
      }
    }

    function showSuccessModal(message) {
      document.getElementById('successMessage').textContent = message;
      document.getElementById('successModal').classList.remove('hidden');
    }

    function closeSuccessModal() {
      document.getElementById('successModal').classList.add('hidden');
    }

    function showErrorModal(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorModal').classList.remove('hidden');
    }

    function closeErrorModal() {
      document.getElementById('errorModal').classList.add('hidden');
    }

    // Load member info from URL token if present, otherwise show camera
    const params = new URLSearchParams(window.location.search);
    const urlToken = params.get('token');
    if (urlToken) {
      loadMemberInfo(urlToken);
    }
  </script>
</body>
</html>
